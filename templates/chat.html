{% extends "base.html" %}

{% block title %}Chat - ArXiv Content Automation Dashboard{% endblock %}
{% block page_title %}Paper Chat{% endblock %}
{% block page_subtitle %}Conversational exploration of research papers{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-full">
        
        <!-- Paper Selection Sidebar -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 h-full">
                <div class="p-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Select Paper</h3>
                    <p class="text-sm text-gray-600 mt-1">Choose a paper to chat about</p>
                </div>
                
                <!-- Search Papers -->
                <div class="p-4 border-b border-gray-200">
                    <input 
                        type="text" 
                        id="paperSearch" 
                        placeholder="Search papers..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>
                
                <!-- Papers List -->
                <div class="flex-1 overflow-y-auto max-h-96">
                    <div id="papersList" class="p-4 space-y-2">
                        <!-- Papers will be loaded here -->
                        <div class="text-center text-gray-500 py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                            <p class="mt-2">Loading papers...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Previous Conversations -->
                <div id="conversationHistoryContainer" class="border-t border-gray-200 p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-sm font-medium text-gray-900">💬 Previous Conversations</h4>
                        <button id="refreshHistoryBtn" class="text-xs text-blue-600 hover:text-blue-800">
                            Refresh
                        </button>
                    </div>
                    <div id="conversationHistory" class="space-y-2 max-h-48 overflow-y-auto">
                        <!-- Conversation history will be loaded here -->
                        <div class="text-center text-gray-500 py-4">
                            <p class="text-xs">No previous conversations</p>
                        </div>
                    </div>
                </div>
                
                <!-- Question Suggestions -->
                <div id="suggestionsContainer" class="hidden border-t border-gray-200 p-4">
                    <h4 class="text-sm font-medium text-gray-900 mb-2">💡 Suggested Questions</h4>
                    <div id="questionSuggestions" class="space-y-1">
                        <!-- Suggestions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Interface -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 h-full flex flex-col">
                
                <!-- Chat Header -->
                <div class="p-4 border-b border-gray-200 bg-gray-50">
                    <div id="chatHeader" class="hidden">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 id="selectedPaperTitle" class="text-lg font-semibold text-gray-900"></h3>
                                <p id="selectedPaperAuthors" class="text-sm text-gray-600"></p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span id="confidenceIndicator" class="hidden px-2 py-1 text-xs rounded-full"></span>
                                <div class="flex items-center space-x-1">
                                    <button id="newChatBtn" class="text-gray-400 hover:text-gray-600" title="New conversation">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                    </button>
                                    <button id="clearChatBtn" class="text-gray-400 hover:text-gray-600" title="Clear current chat">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="noPaperSelected" class="text-center text-gray-500">
                        <svg class="w-12 h-12 mx-auto text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <p class="text-lg font-medium">Select a paper to start chatting</p>
                        <p class="text-sm">Choose a paper from the sidebar to begin your conversation</p>
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 min-h-0">
                    <!-- Messages will appear here -->
                </div>
                
                <!-- Chat Input -->
                <div id="chatInputContainer" class="hidden border-t border-gray-200 p-4">
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Ask a question about the paper..." 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            disabled
                        >
                        <button 
                            id="sendBtn" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Typing indicator -->
                    <div id="typingIndicator" class="hidden mt-2 text-sm text-gray-500">
                        <div class="flex items-center space-x-1">
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                            <span>AI is thinking...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class ChatInterface {
    constructor() {
        this.currentPaper = null;
        this.currentSession = null;
        this.papers = [];
        this.init();
    }
    
    async init() {
        await this.loadPapers();
        await this.loadConversationHistory();
        this.setupEventListeners();
    }
    
    async loadPapers() {
        try {
            const response = await fetch('/api/chat/papers');
            this.papers = await response.json();
            this.renderPapers();
        } catch (error) {
            console.error('Error loading papers:', error);
            this.showError('Failed to load papers');
        }
    }
    
    renderPapers() {
        const papersList = document.getElementById('papersList');
        
        if (this.papers.length === 0) {
            papersList.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <p>No papers available</p>
                </div>
            `;
            return;
        }
        
        papersList.innerHTML = this.papers.map(paper => `
            <div class="paper-item p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors" 
                 data-paper-id="${paper.id}">
                <h4 class="font-medium text-sm text-gray-900 line-clamp-2">${paper.title}</h4>
                <p class="text-xs text-gray-600 mt-1">${paper.authors.slice(0, 2).join(', ')}${paper.authors.length > 2 ? ' et al.' : ''}</p>
                <div class="flex items-center mt-2 space-x-2">
                    ${paper.paper_type ? `<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">${paper.paper_type}</span>` : ''}
                    ${paper.categories.slice(0, 2).map(cat => `<span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">${cat}</span>`).join('')}
                </div>
            </div>
        `).join('');
    }
    
    setupEventListeners() {
        // Paper selection
        document.getElementById('papersList').addEventListener('click', (e) => {
            const paperItem = e.target.closest('.paper-item');
            if (paperItem) {
                const paperId = paperItem.dataset.paperId;
                this.selectPaper(paperId);
            }
        });
        
        // Search papers
        document.getElementById('paperSearch').addEventListener('input', (e) => {
            this.filterPapers(e.target.value);
        });
        
        // Send message
        document.getElementById('sendBtn').addEventListener('click', () => {
            this.sendMessage();
        });
        
        // Enter key to send
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        // New chat
        document.getElementById('newChatBtn').addEventListener('click', () => {
            this.startNewChat();
        });
        
        // Clear chat
        document.getElementById('clearChatBtn').addEventListener('click', () => {
            this.clearChat();
        });
        
        // Refresh conversation history
        document.getElementById('refreshHistoryBtn').addEventListener('click', () => {
            this.loadConversationHistory();
        });
        
        // Suggestion clicks
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-btn')) {
                const question = e.target.textContent;
                document.getElementById('messageInput').value = question;
                this.sendMessage();
            }
        });
    }
    
    async selectPaper(paperId) {
        const paper = this.papers.find(p => p.id === paperId);
        if (!paper) {
            console.error(`Paper not found: ${paperId}`);
            throw new Error(`Paper not found: ${paperId}`);
        }
        
        this.currentPaper = paper;
        
        // Update UI
        document.getElementById('noPaperSelected').classList.add('hidden');
        document.getElementById('chatHeader').classList.remove('hidden');
        document.getElementById('chatInputContainer').classList.remove('hidden');
        
        document.getElementById('selectedPaperTitle').textContent = paper.title;
        document.getElementById('selectedPaperAuthors').textContent = paper.authors.join(', ');
        
        // Enable input
        document.getElementById('messageInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;
        
        // Highlight selected paper
        document.querySelectorAll('.paper-item').forEach(item => {
            item.classList.remove('bg-blue-50', 'border-blue-200');
        });
        document.querySelector(`[data-paper-id="${paperId}"]`).classList.add('bg-blue-50', 'border-blue-200');
        
        // Load suggestions
        await this.loadSuggestions(paperId);
        
        // Clear previous chat
        this.clearChat();
    }
    
    async loadSuggestions(paperId) {
        try {
            const response = await fetch(`/api/chat/papers/${paperId}/suggestions`);
            const suggestions = await response.json();
            
            const container = document.getElementById('suggestionsContainer');
            const suggestionsDiv = document.getElementById('questionSuggestions');
            
            if (suggestions.length > 0) {
                suggestionsDiv.innerHTML = suggestions.map(suggestion => `
                    <button class="suggestion-btn text-left w-full px-2 py-1 text-xs text-blue-600 hover:bg-blue-50 rounded transition-colors">
                        ${suggestion}
                    </button>
                `).join('');
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error loading suggestions:', error);
        }
    }
    
    filterPapers(query) {
        const filtered = this.papers.filter(paper => 
            paper.title.toLowerCase().includes(query.toLowerCase()) ||
            paper.authors.some(author => author.toLowerCase().includes(query.toLowerCase()))
        );
        
        const papersList = document.getElementById('papersList');
        papersList.innerHTML = filtered.map(paper => `
            <div class="paper-item p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors" 
                 data-paper-id="${paper.id}">
                <h4 class="font-medium text-sm text-gray-900 line-clamp-2">${paper.title}</h4>
                <p class="text-xs text-gray-600 mt-1">${paper.authors.slice(0, 2).join(', ')}${paper.authors.length > 2 ? ' et al.' : ''}</p>
                <div class="flex items-center mt-2 space-x-2">
                    ${paper.paper_type ? `<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">${paper.paper_type}</span>` : ''}
                    ${paper.categories.slice(0, 2).map(cat => `<span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">${cat}</span>`).join('')}
                </div>
            </div>
        `).join('');
    }
    
    async sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message || !this.currentPaper) return;
        
        // Clear input and show typing
        input.value = '';
        this.showTyping();
        
        // Add user message
        this.addMessage('user', message);
        
        try {
            const response = await fetch('/api/chat/message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    paper_id: this.currentPaper.id,
                    message: message,
                    session_id: this.currentSession
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                this.currentSession = data.session_id;
                this.addMessage('assistant', data.response, {
                    grounded: data.grounded,
                    sources: data.sources,
                    limitations: data.limitations
                });
            } else {
                this.addMessage('assistant', 'Sorry, I encountered an error processing your message.', { error: true });
            }
        } catch (error) {
            console.error('Error sending message:', error);
            this.addMessage('assistant', 'Sorry, I encountered an error processing your message.', { error: true });
        } finally {
            this.hideTyping();
            // Refresh conversation history to show updated message count
            this.loadConversationHistory();
        }
    }
    
    addMessage(role, content, metadata = {}) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
        
        const isUser = role === 'user';
        const bgColor = isUser ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-900';
        const alignment = isUser ? 'text-right' : 'text-left';
        
        let metadataHtml = '';
        
        if (metadata.sources && metadata.sources.length > 0) {
            metadataHtml += `<div class="text-xs text-gray-500 mt-1">📚 ${metadata.sources.join(', ')}</div>`;
        }
        
        if (metadata.limitations) {
            metadataHtml += `<div class="text-xs text-orange-600 mt-1">⚠️ ${metadata.limitations}</div>`;
        }
        
        if (!isUser && metadata.grounded === false) {
            metadataHtml += `<div class="text-xs text-yellow-600 mt-1">ℹ️ Response may not be fully grounded in paper content</div>`;
        }
        
        messageDiv.innerHTML = `
            <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${bgColor} ${alignment}">
                <div class="whitespace-pre-wrap">${content}</div>
                ${metadataHtml}
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    showTyping() {
        document.getElementById('typingIndicator').classList.remove('hidden');
    }
    
    hideTyping() {
        document.getElementById('typingIndicator').classList.add('hidden');
    }
    

    
    async loadConversationHistory() {
        try {
            const response = await fetch('/api/chat/sessions');
            const sessions = await response.json();
            
            const historyContainer = document.getElementById('conversationHistory');
            
            if (sessions.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p class="text-xs">No previous conversations</p>
                    </div>
                `;
                return;
            }
            
            // Filter out sessions with no messages
            const activeSessions = sessions.filter(session => session.message_count > 0);
            
            if (activeSessions.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p class="text-xs">No previous conversations</p>
                    </div>
                `;
                return;
            }
            
            historyContainer.innerHTML = activeSessions.slice(0, 10).map(session => `
                <div class="conversation-item p-2 border border-gray-200 rounded cursor-pointer hover:bg-gray-50 transition-colors" 
                     data-session-id="${session.session_id}" data-paper-id="${session.paper_id}">
                    <div class="text-xs font-medium text-gray-900 truncate">${session.paper_title}</div>
                    <div class="text-xs text-gray-600 mt-1 truncate">Messages: ${session.message_count}</div>
                    <div class="text-xs text-gray-500 mt-1">${this.formatDate(session.last_activity)}</div>
                </div>
            `).join('');
            
            // Add click handlers for conversation items
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sessionId = item.dataset.sessionId;
                    const paperId = item.dataset.paperId;
                    this.loadConversation(sessionId, paperId);
                });
            });
            
        } catch (error) {
            console.error('Error loading conversation history:', error);
        }
    }
    
    async loadConversation(sessionId, paperId) {
        try {
            console.log(`Loading conversation: sessionId=${sessionId}, paperId=${paperId}`);
            
            // Select the paper first
            await this.selectPaper(paperId);
            
            // Set the current session
            this.currentSession = sessionId;
            
            // Load conversation history
            console.log(`Fetching history from: /api/chat/sessions/${sessionId}/history`);
            const response = await fetch(`/api/chat/sessions/${sessionId}/history`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const messages = await response.json();
            console.log(`Loaded ${messages.length} messages`);
            
            // Clear current chat and load history
            this.clearChat();
            
            for (const message of messages) {
                this.addMessage(message.role, message.content, {
                    confidence: message.confidence,
                    grounded: message.grounded,
                    sources: message.sources,
                    limitations: message.limitations
                });
            }
            
            // Update confidence indicator with latest assistant message
            const lastAssistantMsg = messages.filter(m => m.role === 'assistant').pop();
            if (lastAssistantMsg) {
                this.updateConfidenceIndicator(lastAssistantMsg.confidence, lastAssistantMsg.grounded);
            }
            
            console.log('Conversation loaded successfully');
            
        } catch (error) {
            console.error('Error loading conversation:', error);
            this.showError(`Failed to load conversation: ${error.message}`);
        }
    }
    
    startNewChat() {
        if (this.currentPaper) {
            this.clearChat();
            this.currentSession = null;
            // Keep the same paper selected but start fresh
        }
    }
    
    clearChat() {
        document.getElementById('chatMessages').innerHTML = '';
        this.currentSession = null;
        document.getElementById('confidenceIndicator').classList.add('hidden');
    }
    
    formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
    }
    
    showError(message) {
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = `
            <div class="text-center text-red-500 py-8">
                <p>${message}</p>
            </div>
        `;
    }
    
    formatDate(dateString) {
        try {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        } catch (error) {
            return 'Unknown';
        }
    }
    
    updateConfidenceIndicator(confidence, grounded) {
        const indicator = document.getElementById('confidenceIndicator');
        
        if (confidence !== undefined && confidence !== null) {
            let color, text;
            if (confidence > 0.7) {
                color = 'bg-green-100 text-green-800';
                text = 'High Confidence';
            } else if (confidence > 0.4) {
                color = 'bg-yellow-100 text-yellow-800';
                text = 'Medium Confidence';
            } else {
                color = 'bg-red-100 text-red-800';
                text = 'Low Confidence';
            }
            
            indicator.className = `px-2 py-1 text-xs rounded-full ${color}`;
            indicator.textContent = text + (grounded ? ' ✓' : '');
            indicator.classList.remove('hidden');
        } else {
            indicator.classList.add('hidden');
        }
    }
}

// Initialize chat interface when page loads
document.addEventListener('DOMContentLoaded', () => {
    new ChatInterface();
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}